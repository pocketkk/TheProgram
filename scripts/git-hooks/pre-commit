#!/bin/bash
# Pre-commit hook: Quick scan for obvious secrets before committing
# For deeper scanning, the pre-push hook does more thorough checks

set -e

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

FOUND_SECRETS=0

for file in $STAGED_FILES; do
    # Block .env files immediately
    if [[ "$file" == ".env" || "$file" == *"/.env" ]]; then
        echo -e "${RED}ERROR: Cannot commit .env file: $file${NC}"
        echo -e "${RED}Use 'git reset HEAD $file' to unstage${NC}"
        FOUND_SECRETS=1
        continue
    fi

    # Skip non-text files
    if [ ! -f "$file" ]; then
        continue
    fi

    # Skip git hook files (they contain the patterns we're searching for)
    if [[ "$file" == *"/git-hooks/"* || "$file" == ".git/hooks/"* ]]; then
        continue
    fi

    # Quick check for obvious API key patterns in staged content
    if git diff --cached "$file" 2>/dev/null | grep -qE 'sk-ant-api[a-zA-Z0-9_-]{50,}'; then
        echo -e "${RED}ERROR: Anthropic API key detected in $file${NC}"
        FOUND_SECRETS=1
    fi

    if git diff --cached "$file" 2>/dev/null | grep -qE 'AKIA[0-9A-Z]{16}'; then
        echo -e "${RED}ERROR: AWS Access Key detected in $file${NC}"
        FOUND_SECRETS=1
    fi

    if git diff --cached "$file" 2>/dev/null | grep -qE -- '-----BEGIN.*PRIVATE KEY-----'; then
        echo -e "${RED}ERROR: Private key detected in $file${NC}"
        FOUND_SECRETS=1
    fi
done

if [ $FOUND_SECRETS -eq 1 ]; then
    echo ""
    echo -e "${RED}COMMIT BLOCKED: Secrets detected in staged files${NC}"
    echo "Remove secrets before committing."
    exit 1
fi

exit 0
