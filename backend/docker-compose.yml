version: '3.8'

# ============================================================================
# The Program - Docker Compose Configuration (SQLite Personal App)
# ============================================================================
# Simplified single-container architecture for personal use
# No PostgreSQL, no Redis - just the backend with SQLite
# ============================================================================

services:
  # FastAPI Backend Application with SQLite
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: theprogram_backend
    restart: unless-stopped

    environment:
      # Application
      APP_NAME: ${APP_NAME:-The Program}
      APP_ENV: ${APP_ENV:-production}
      DEBUG: ${DEBUG:-false}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}

      # Server
      HOST: 0.0.0.0
      PORT: 8000
      API_V1_STR: /api

      # SQLite Database
      SQLITE_DB_PATH: /app/data/theprogram.db
      SQLITE_ENABLE_FOREIGN_KEYS: true
      SQLITE_JOURNAL_MODE: WAL
      SQLITE_SYNCHRONOUS: NORMAL
      SQLITE_CACHE_SIZE: -2000

      # Security
      SECRET_KEY: ${SECRET_KEY:-CHANGE_THIS_IN_PRODUCTION}
      JWT_ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      REQUIRE_PASSWORD: ${REQUIRE_PASSWORD:-true}

      # API Keys
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      GEONAMES_USERNAME: ${GEONAMES_USERNAME:-}

      # CORS
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://localhost:5173}
      CORS_ALLOW_CREDENTIALS: true

      # Swiss Ephemeris
      EPHEMERIS_PATH: /app/ephemeris

      # Features
      INTERPRETATIONS_ENABLED: ${INTERPRETATIONS_ENABLED:-true}
      ENABLE_CACHE: false  # No Redis in single-user app

    volumes:
      # CRITICAL: Persistent SQLite database
      - sqlite_data:/app/data

      # Ephemeris data (persistent)
      - ephemeris_data:/app/ephemeris

      # Application logs (persistent)
      - logs_data:/app/logs

      # Generated reports and storage (persistent)
      - storage_data:/app/storage

      # Optional: Mount code for development (uncomment for live reload)
      # - ./app:/app/app:ro

    ports:
      - "${BACKEND_PORT:-8000}:8000"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Initialize database on startup
    command: >
      sh -c "
        echo 'Starting The Program backend...' &&
        echo 'Database will be created at: /app/data/theprogram.db' &&
        uvicorn app.main:app --host 0.0.0.0 --port 8000
      "

# Named Volumes for Data Persistence
volumes:
  # SQLite database file (MOST IMPORTANT - contains all user data)
  sqlite_data:
    driver: local
    # Optional: Use bind mount for easy access
    # driver_opts:
    #   type: none
    #   device: ${PWD}/data
    #   o: bind

  # Ephemeris astronomical data
  ephemeris_data:
    driver: local

  # Application logs
  logs_data:
    driver: local

  # Generated reports and file storage
  storage_data:
    driver: local

# No networks needed for single-container app
# Backend is directly accessible on host port
