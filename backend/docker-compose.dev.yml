version: '3.8'

# Development-specific overrides
# Use with: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  postgres:
    # Expose PostgreSQL port for local development tools
    ports:
      - "5432:5432"
    environment:
      # Less strict settings for development
      POSTGRES_PASSWORD: devpassword

  backend:
    build:
      context: .
      dockerfile: Dockerfile
      # Use cache for faster rebuilds
      cache_from:
        - theprogram_backend:latest

    environment:
      # Development settings
      APP_ENV: development
      DEBUG: "true"
      LOG_LEVEL: debug

      # Development database
      DATABASE_URL: postgresql://theprogram:devpassword@postgres:5432/theprogram_db

      # Simpler secret for dev (NEVER use in production!)
      SECRET_KEY: dev-secret-key-change-in-production

      # Longer token expiration for development
      ACCESS_TOKEN_EXPIRE_MINUTES: 1440  # 24 hours

      # CORS - allow all origins in dev
      CORS_ORIGINS: "*"

    volumes:
      # Mount source code for hot-reload
      - ./app:/app/app:ro
      - ./alembic:/app/alembic:ro
      - ./tests:/app/tests:ro

      # Ephemeris and logs
      - ephemeris_data:/app/ephemeris
      - ./logs:/app/logs  # Map to local directory for easy access

    # Enable hot-reload
    command: >
      sh -c "
        echo 'DEV MODE: Waiting for database...' &&
        sleep 5 &&
        echo 'Running migrations...' &&
        alembic upgrade head &&
        echo 'Starting with auto-reload...' &&
        uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
      "

    # Override healthcheck for faster feedback in dev
    healthcheck:
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  # PgAdmin for database management (development only)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: theprogram_pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@theprogram.local}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - theprogram_network

volumes:
  pgadmin_data:
    driver: local
