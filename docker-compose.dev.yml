# Development overrides for docker-compose.yml
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up

version: '3.8'

services:
  # Frontend in development mode with hot reload
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
      args:
        - VITE_API_URL=${VITE_API_URL:-http://backend:8000}
    volumes:
      # Mount source code for hot reload
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      - ./frontend/index.html:/app/index.html
      - ./frontend/vite.config.ts:/app/vite.config.ts
      - ./frontend/tsconfig.json:/app/tsconfig.json
      - ./frontend/tsconfig.node.json:/app/tsconfig.node.json
      - ./frontend/tailwind.config.js:/app/tailwind.config.js
      - ./frontend/postcss.config.js:/app/postcss.config.js
      # Exclude node_modules to avoid conflicts
      - /app/node_modules
    command: npm run dev -- --host 0.0.0.0 --port 3000
    environment:
      - NODE_ENV=development
      - VITE_API_URL=${VITE_API_URL:-http://backend:8000}
      - CHOKIDAR_USEPOLLING=true  # Better file watching in Docker
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # Backend in development mode with hot reload
  backend:
    volumes:
      # Mount code for development (live reload)
      - ./backend/app:/app/app
      - ./backend/alembic:/app/alembic
      # SQLite database persistence (host directory)
      - ./data:/app/data
      # Ephemeris data (persistent)
      - ephemeris_data:/app/ephemeris
      # Logs (persistent)
      - logs_data:/app/logs
      # Storage for reports
      - storage_data:/app/storage
    environment:
      APP_ENV: development
      DEBUG: "true"
      LOG_LEVEL: debug
      # SQLite database
      DATABASE_URL: sqlite:///./data/app.db
      # Disable Redis for single-user mode
      REDIS_ENABLED: "false"
    # Use --reload for uvicorn hot reload
    command: >
      sh -c "
        echo 'Ensuring data directory exists...' &&
        mkdir -p /app/data &&
        echo 'Running database migrations...' &&
        alembic upgrade head &&
        echo 'Starting application in development mode with hot reload...' &&
        uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
      "
